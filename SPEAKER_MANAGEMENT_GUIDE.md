# 👥 話者管理ガイド - 初心者向け完全マニュアル

## 🎯 このガイドについて

このガイドでは、日本語話者認識システム（単一話者識別・複数話者分析・手動話者分離対応）での**話者管理**について、初心者の方にもわかりやすく説明します。

**重要**: 話者管理は**フォルダ操作だけ**で簡単にできます！

## 📋 目次

1. [話者管理とは？](#-話者管理とは)
2. [基本的な仕組み](#-基本的な仕組み)
3. [新規話者の追加方法](#-新規話者の追加方法)
4. [話者の削除・編集](#-話者の削除編集)
5. [複数話者分析での利用](#-複数話者分析での利用)
6. [よくある質問](#-よくある質問)
7. [トラブルシューティング](#-トラブルシューティング)

## 🤔 話者管理とは？

### 簡単に言うと...
「このアプリに、誰の声を覚えさせるか」を決めることです。

### 具体例
```
あなたの会社に3人います：
- 田中部長
- 佐藤課長  
- 山田主任

→ この3人の声をアプリに覚えさせる
→ 単一話者識別: 「田中部長の声です」と教えてくれる
→ 複数話者分析: 「0-5秒: 田中部長、5-10秒: 佐藤課長」と時系列で分析  
→ 手動話者分離: リアルタイム音声同期で精密なセグメント作成・話者割当
```

## 🏗️ 基本的な仕組み

### 📁 フォルダ構造（これが全て！）

```
japanese-speaker-recognition_GPU_nvidia/
└── enroll/                    ← この中に話者を登録
    ├── 田中部長/
    │   ├── 挨拶.wav
    │   ├── 会議発言.wav
    │   └── 電話応対.wav
    ├── 佐藤課長/
    │   ├── 朝礼.wav
    │   └── プレゼン.wav
    └── 山田主任/
        └── 自己紹介.wav
```

### 💡 重要なポイント

1. **enroll**フォルダの中に話者ごとのフォルダを作る
2. 各話者フォルダに、その人の音声ファイルを入れる
3. それだけ！特別な処理は不要

## ➕ 新規話者の追加方法

### 🎬 Step by Step ガイド

#### Step 1: 音声ファイルを準備
```
準備するもの：
✅ その人の声が録音された音声ファイル
✅ 長さ: 2秒〜30秒程度（システム制限）
✅ 形式: WAV, MP3, FLAC, M4A, OGG
✅ 数量: 2〜5個くらい
✅ 音質: できるだけクリアでノイズの少ない音声

例：
- 自己紹介.wav
- 挨拶.wav
- 会議での発言.wav
```

#### Step 2: フォルダを作成

**Windows（エクスプローラー）の場合**:
1. `enroll`フォルダを開く
2. 右クリック → 「新規作成」 → 「フォルダー」
3. フォルダ名を入力（例：`鈴木一郎`）

**コマンドプロンプトの場合**:
```bash
cd C:\Users\uenot\japanese-speaker-recognition_GPU_nvidia
mkdir enroll\鈴木一郎
```

#### Step 3: 音声ファイルをコピー

**エクスプローラーの場合**:
1. 音声ファイルを選択
2. Ctrl+C でコピー
3. `enroll\鈴木一郎`フォルダを開く
4. Ctrl+V で貼り付け

**コマンドプロンプトの場合**:
```bash
copy "C:\音声ファイルの場所\自己紹介.wav" "enroll\鈴木一郎\"
```

#### Step 4: アプリで確認・登録

1. **ブラウザでアプリを開く**: http://localhost:8501
2. **サイドバー**の「🚀 モデル初期化」をクリック
3. **1-2分待つ**（初回のみモデルダウンロード）
4. **「👥 話者管理」タブ**で確認

#### Step 5: 完了確認

話者管理タブに以下のように表示されれば成功：
```
✅ 有効な話者 (4名)
- 田中部長: 3ファイル
- 佐藤課長: 2ファイル  
- 山田主任: 1ファイル
- 鈴木一郎: 2ファイル  ← 新規追加された！
```

### 🎉 実際の例：営業チームの場合

#### 登録前
```
enroll/
├── 田中部長/
└── 佐藤課長/
```

#### 新人「山田営業」を追加

1. **フォルダ作成**: `enroll\山田営業`
2. **音声ファイル追加**:
   ```
   enroll\山田営業\
   ├── 入社挨拶.wav
   ├── 商品説明.wav
   └── 顧客対応.wav
   ```
3. **アプリで初期化**: 「🚀 モデル初期化」クリック
4. **完了**: 10秒後に識別可能

#### 登録後
```
enroll/
├── 田中部長/
├── 佐藤課長/
└── 山田営業/      ← 追加完了！
```

## 🗑️ 話者の削除・編集

### 🚫 話者を削除する

#### 完全削除
```bash
# フォルダごと削除
rmdir /s enroll\削除したい人
```

または**エクスプローラー**で：
1. `enroll`フォルダを開く
2. 削除したい話者フォルダを右クリック
3. 「削除」を選択

#### 一時的に無効にする
```bash
# フォルダ名の先頭に「_」を付ける
rename enroll\山田営業 enroll\_山田営業
```

→ アプリは「_」で始まるフォルダを無視します

### ✏️ 話者情報を編集する

#### 音声ファイルを追加
```
enroll\田中部長\
├── 挨拶.wav           ← 既存
├── 会議発言.wav       ← 既存
└── 新しい録音.wav     ← 新規追加
```

#### 音声ファイルを削除
不要な音声ファイルを削除するだけ

#### 話者名を変更
```bash
# フォルダ名を変更
rename enroll\田中 enroll\田中部長
```

### 🔄 変更後は必ず初期化

**重要**: フォルダやファイルを変更した後は：
1. Webアプリで「🚀 モデル初期化」をクリック
2. 1-2分待つ（モデル読み込み）
3. 「👥 話者管理」タブで確認

## 🎭 複数話者分析での利用

### 複数話者分析の仕組み

登録された話者は、複数話者分析でも自動的に利用されます：

1. **ダイアライゼーション**: pyannote.audioが「いつ誰が話しているか」を検出
2. **話者認識**: 各セグメントで登録話者から最適な候補を識別
3. **結果表示**: タイムライン形式で話者の切り替えを可視化

### 複数話者分析専用の設定

#### HF_TOKEN設定（必須）
```bash
# .envファイルに追加
echo "HF_TOKEN=your_huggingface_token_here" > .env
```

#### 利用規約の同意
https://huggingface.co/pyannote/speaker-diarization にアクセスして利用規約に同意

### 複数話者分析での表示設定

Webアプリで以下の設定が可能：
- 🗾 **JVS話者を結果に表示**: JVS話者の表示・非表示
- 🌐 **Common Voice話者を結果に表示**: Common Voice話者の表示・非表示

#### 実際の使用例
```
📊 分析結果:
🟢 セグメント 1: 0.0s - 3.2s → 田中部長 (0.856)
🟢 セグメント 2: 3.2s - 6.1s → 佐藤課長 (0.743)
🟢 セグメント 3: 6.1s - 9.5s → 田中部長 (0.821)

👥 話者別統計:
田中部長: 2セグメント, 6.6秒 (70%), 信頼度0.838
佐藤課長: 1セグメント, 2.9秒 (30%), 信頼度0.743
```

## ❓ よくある質問

### Q1: JVSみたいに埋め込み作成は必要？

**A: 不要です！**

| JVS/Common Voice | 普通の話者管理 |
|------------------|---------------|
| 30分〜1時間の処理 | 数秒〜数十秒 |
| .npzファイル作成 | フォルダ操作だけ |
| 1回だけ実行 | いつでも変更可能 |

### Q2: 何個の音声ファイルが必要？

**A: 2〜5個が目安**

```
✅ 推奨:
- 3個: 最低限
- 5個: 理想的
- 10個: 十分すぎる

❌ 避ける:
- 1個: 少なすぎ
- 20個: 多すぎ（処理が重くなる）
```

### Q3: 音声の長さはどのくらい？

**A: 3秒〜15秒が最適**

```
✅ 良い例:
- 「おはようございます。田中です」(5秒)
- 「会議の件で連絡しました」(7秒)
- 「資料の確認をお願いします」(6秒)

❌ 悪い例:
- 「はい」(1秒) → 短すぎ
- 30秒の長い説明 → 長すぎ
```

### Q4: どんな内容の音声が良い？

**A: 自然な話し方の音声**

```
✅ 推奨:
- 挨拶
- 自己紹介
- 仕事の話
- 電話での会話

❌ 避ける:
- 歌
- 叫び声
- ささやき声
- 音楽付き
```

### Q5: ファイル名は何でも良い？

**A: わかりやすい名前にしましょう**

```
✅ 良い例:
- 自己紹介.wav
- 朝礼挨拶.wav
- 20241215_会議.wav

❌ 悪い例:
- audio.wav
- 1.wav
- test.wav
```

## 🔧 トラブルシューティング

### 😵 話者が表示されない

#### 原因1: フォルダが間違っている
```
❌ 間違い: japanese-speaker-recognition\田中部長\
✅ 正解: japanese-speaker-recognition\enroll\田中部長\
```

#### 原因2: 音声ファイルの形式が対応していない
```
✅ 対応形式: .wav, .mp3, .flac, .m4a, .ogg
❌ 非対応: .mp4, .avi, .txt, .doc
```

#### 原因3: 音声が短すぎる/長すぎる
```bash
# 音声の長さを確認
python -c "
import librosa
y, sr = librosa.load('enroll/話者名/音声.wav')
print(f'音声長: {len(y)/sr:.1f}秒')
"
```

### 😓 初期化が失敗する

#### 解決法1: アプリを再起動
```bash
# Ctrl+C でアプリを停止
# 再度起動
streamlit run app.py
```

#### 解決法2: ログを確認
アプリの画面に表示されるエラーメッセージを確認

#### 解決法3: 音声ファイルを確認
- 2秒以上30秒以下か？
- 対応形式か？
- ファイルが壊れていないか？

### 🤯 識別精度が悪い

#### 改善法1: 音声を追加
```
enroll\田中部長\
├── 挨拶.wav
├── 会議発言.wav
├── 電話応対.wav    ← 追加
├── プレゼン.wav    ← 追加
└── 朝礼.wav        ← 追加
```

#### 改善法2: 音質を改善
- ノイズの少ない音声
- クリアな発音
- 適切な音量
- 異なる録音環境の音声を含める

#### 改善法3: 背景モデルを作成
```bash
# JVS埋め込みを作成（精度向上）
python prep_jvs_embeddings.py C:\path\to\jvs

# Common Voice埋め込みを作成
python prep_common_voice_embeddings.py --max-samples 5000
```

#### 改善法4: AS-Norm設定確認
`config.json`で以下を確認：
```json
{
  "recognition": {
    "use_score_normalization": true,
    "background_speakers_count": 100
  }
}
```

## 🎯 実践的な使用例

### 📊 ケース1: 小さな会社（5人）

#### 初期設定
```
enroll/
├── 社長_田中/
├── 部長_佐藤/
├── 課長_山田/
├── 主任_鈴木/
└── 新人_高橋/
```

#### 運用
- 新人入社 → フォルダ追加
- 退職 → フォルダ削除
- 昇進 → フォルダ名変更

### 🏢 ケース2: コールセンター

#### オペレーター管理
```
enroll/
├── オペレーターA/
├── オペレーターB/
├── オペレーターC/
├── 管理者_田中/
└── 研修生_新人/
```

#### 月次更新
- 新人研修終了 → `研修生_新人` → `オペレーターD`
- 異動 → フォルダ削除
- 追加録音 → 音声ファイル追加

### 🎓 ケース3: 研究・教育

#### 実験参加者管理
```
enroll/
├── 参加者001/
├── 参加者002/
├── 参加者003/
└── 制御群_基準音声/
```

## 📝 まとめ

### ✅ 覚えておくべきポイント

1. **話者管理 = フォルダ操作**
2. **enroll フォルダに話者ごとのフォルダを作成**
3. **音声ファイルをコピー（2-30秒、クリアな音質）**
4. **「🚀 モデル初期化」をクリック**
5. **1-2分で完了（初回のみ）**

### ⭐ 新機能: 複数話者分析

- ✅ 登録した話者は自動で複数話者分析にも利用
- ✅ タイムライン形式で話者の切り替わりを可視化
- ✅ pyannote.audioで高精度な話者分離
- ✅ HF_TOKEN設定が必要（一度だけ）

### 🚫 JVSとは違います

- ❌ 埋め込み作成スクリプト不要
- ❌ 長時間処理不要
- ❌ .npzファイル作成不要
- ✅ フォルダ操作だけ
- ✅ 1-2分で反映
- ✅ いつでも変更可能

### 🎉 これで話者管理はマスター！

分からないことがあれば、まずは：
1. この「📁 フォルダ構造」を確認
2. 「🚀 モデル初期化」を試す
3. 「👥 話者管理」タブで状況確認
4. 複数話者分析も試してみる！

**話者管理は思っているより簡単です！**